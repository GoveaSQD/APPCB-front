<div class="card p-4">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Toolbar -->
  <p-toolbar styleClass="mb-4">
    <ng-template pTemplate="left">
      <div class="flex flex-wrap gap-2">
        <p-button 
          label="Nueva Universidad" 
          icon="pi pi-plus" 
          styleClass="p-button-success"
          (onClick)="openNew()">
        </p-button>
      </div>
    </ng-template>
    
    <ng-template pTemplate="right">
      <div class="flex flex-wrap gap-2">
        <p-button 
          label="Refrescar" 
          icon="pi pi-refresh" 
          styleClass="p-button-outlined"
          (onClick)="loadUniversidades()">
        </p-button>
      </div>
    </ng-template>
  </p-toolbar>

  <!-- Buscador -->
  <div class="flex justify-content-end mb-3">
    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input 
        pInputText 
        type="text" 
        [(ngModel)]="searchText" 
        placeholder="Buscar universidad..." 
        class="p-2">
    </span>
  </div>

  <!-- Tabla de universidades -->
  <p-table 
    [value]="filteredUniversidades" 
    [loading]="loading"
    [paginator]="true" 
    [rows]="10"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} universidades"
    [rowsPerPageOptions]="[10, 25, 50]"
    responsiveLayout="stack"
    styleClass="p-datatable-striped">
    
    <ng-template pTemplate="header">
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Ciudad</th>
        <th>País</th>
        <th>Estado</th>
        <th>Estatus</th>
        <th style="width: 120px">Acciones</th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-universidad>
      <tr>
        <td>{{ universidad.id_universidad }}</td>
        <td class="font-bold">{{ universidad.nombre }}</td>
        <td>{{ universidad.ciudad }}</td>
        <td>{{ universidad.pais }}</td>
        <td>{{ universidad.estado || '-' }}</td>
        <td>
          <p-tag 
            [severity]="getSeverity(universidad.estatus)"
            [value]="universidad.estatus ? 'Activo' : 'Inactivo'">
          </p-tag>
        </td>
        <td>
          <div class="flex gap-2">
            <p-button 
              icon="pi pi-pencil" 
              styleClass="p-button-rounded p-button-text p-button-warning"
              (onClick)="editUniversidad(universidad)">
            </p-button>
            <p-button 
              icon="pi pi-trash" 
              styleClass="p-button-rounded p-button-text p-button-danger"
              (onClick)="deleteUniversidad(universidad)">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-5">
          <i class="pi pi-building text-4xl text-gray-400 mb-3 block"></i>
          <p class="text-gray-500">No hay universidades registradas</p>
          <p-button 
            label="Crear primera universidad" 
            icon="pi pi-plus"
            styleClass="p-button-outlined mt-3"
            (onClick)="openNew()">
          </p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Diálogo para crear/editar -->
  <p-dialog 
    [(visible)]="universidadDialog" 
    [style]="{width: '550px'}" 
    [modal]="true"
    [draggable]="false" 
    [resizable]="false"
    header="{{ editingUniversidad ? 'Editar Universidad' : 'Nueva Universidad' }}"
    [closable]="!loading">
    
    <form [formGroup]="universidadForm">
      <div class="flex flex-column gap-4">
        <!-- Nombre -->
        <div class="field">
          <label for="nombre" class="block font-medium mb-2">
            Nombre <span class="text-red-500">*</span>
          </label>
          <input 
            pInputText 
            id="nombre" 
            formControlName="nombre" 
            class="w-full"
            placeholder="Ej: Universidad Nacional Autónoma de México"
            [class.ng-invalid]="submitted && universidadForm.get('nombre')?.invalid">
          @if (submitted && universidadForm.get('nombre')?.invalid) {
            <small class="p-error block mt-1">
              @if (universidadForm.get('nombre')?.errors?.['required']) {
                El nombre es requerido
              }
              @if (universidadForm.get('nombre')?.errors?.['minlength']) {
                Mínimo 3 caracteres
              }
            </small>
          }
        </div>

        <!-- Ciudad y País -->
        <div class="grid">
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="ciudad" class="block font-medium mb-2">
                Ciudad <span class="text-red-500">*</span>
              </label>
              <input 
                pInputText 
                id="ciudad" 
                formControlName="ciudad" 
                class="w-full"
                placeholder="Ej: Ciudad de México"
                [class.ng-invalid]="submitted && universidadForm.get('ciudad')?.invalid">
              @if (submitted && universidadForm.get('ciudad')?.invalid) {
                <small class="p-error block mt-1">La ciudad es requerida</small>
              }
            </div>
          </div>

          <div class="col-12 md:col-6">
            <div class="field">
              <label for="pais" class="block font-medium mb-2">
                País <span class="text-red-500">*</span>
              </label>
              <p-dropdown 
                id="pais"
                formControlName="pais"
                [options]="paises"
                [filter]="true"
                placeholder="Selecciona un país"
                styleClass="w-full"
                [showClear]="true"
                [class.ng-invalid]="submitted && universidadForm.get('pais')?.invalid">
              </p-dropdown>
              @if (submitted && universidadForm.get('pais')?.invalid) {
                <small class="p-error block mt-1">El país es requerido</small>
              }
            </div>
          </div>
        </div>

        <!-- Estado (opcional) -->
        <div class="field">
          <label for="estado" class="block font-medium mb-2">Estatus</label>
          <p-dropdown 
            id="estado"
            formControlName="estado"
            [options]="estados"
            placeholder="Selecciona un estado"
            styleClass="w-full"
            [showClear]="true">
          </p-dropdown>
        </div>

        <!-- Estatus activo -->
        <div class="field">
          <div class="flex align-items-center gap-2">
            <p-checkbox 
              formControlName="estatus" 
              [binary]="true" 
              inputId="estatus">
            </p-checkbox>
            <label for="estatus" class="font-medium">Universidad activa</label>
          </div>
        </div>
      </div>
    </form>
    
    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          styleClass="p-button-text"
          [disabled]="loading"
          (onClick)="hideDialog()">
        </p-button>
        <p-button 
          label="Guardar" 
          icon="pi pi-check" 
          [loading]="loading"
          (onClick)="saveUniversidad()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>